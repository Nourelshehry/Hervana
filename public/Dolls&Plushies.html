<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dolls - Hervana</title>
  <link rel="stylesheet" href="/public/all-products.css"/>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="logo"><a href="index.html">Hervana</a></div>
    <div class="header-actions">
      <button id="cart-btn">üõí <span id="cart-count">0</span></button>
    </div>
  </header>

  <!-- Products -->
  <section class="products">
    <h2>Dolls</h2>
    <div class="product-grid" id="product-list"></div>
  </section>

  <!-- Cart message -->
  <div id="cart-message" class="cart-message">Added to cart!</div>

  <!-- Cart Sidebar -->
  <aside id="cart-sidebar" class="cart-sidebar">
    <button id="close-cart" class="close-btn">‚úñ</button>
    <h2>Your Cart</h2>
    <ul id="cart-items"></ul>
    <button id="checkout-btn" class="checkout-btn">Checkout</button>
  </aside>

  <footer>
    <p>&copy; 2025 Hervana. All rights reserved.</p>
  </footer>

  <!-- Scripts -->
  <script src="/thecart.js" defer></script>
  <script src="/dolls.js" defer></script>

</body>
</html>

<script>

console.log("üß∏ DOLLS PAGE LOADED");

/* ===============================
   Helpers
================================ */

// ŸÜÿ≠ŸàŸÑ images ŸÑÿ£Ÿä Array ŸÖÿ∂ŸÖŸàŸÜ
function normalizeImages(product) {
  if (!product || !product.images) return [];

  if (typeof product.images === "string") {
    try {
      return JSON.parse(product.images);
    } catch {
      return [];
    }
  }

  if (Array.isArray(product.images)) {
    return product.images;
  }

  return [];
}

// ŸÜÿ∑ŸÑÿπ URL ŸÖÿ∏ÿ®Ÿàÿ∑ ŸÑŸÑÿµŸàÿ±ÿ©
function getImageUrl(img) {
  if (!img) return "/images/placeholder.png";
  if (img.startsWith("http")) return img;
  return `https://hervana.pages.dev/${img}`;
}

/* ===============================
   Load Dolls from DB
================================ */
document.addEventListener("DOMContentLoaded", async () => {
  const productList = document.getElementById("product-list");

  try {
    const res = await fetch(
      "https://hervanastore.nourthranduil.workers.dev/products"
    );

    if (!res.ok) throw new Error("Failed to fetch products");

    const products = await res.json();
    console.log("‚úÖ PRODUCTS:", products);

    // ‚úÖ ŸÅŸÑÿ™ÿ±ÿ© Dolls ŸÖŸÜ ÿßŸÑŸÄ DB
    const dolls = products
      .map(p => ({ ...p, imagesArr: normalizeImages(p) }))
      .filter(
        p =>
          p.category?.toLowerCase() === "dolls" &&
          p.imagesArr.length
      );

    productList.innerHTML = "";

    if (!dolls.length) {
      productList.innerHTML = "<p>No dolls found.</p>";
      return;
    }

    dolls.forEach(product => {
      const imgSrc = getImageUrl(product.imagesArr[0]);

      const card = document.createElement("div");
      card.className = "product-card";

      card.innerHTML = `
        <img src="${imgSrc}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>${product.price} EGP</p>

        <button 
          class="add-to-cart"
          data-id="${product.id}"
          data-name="${product.name}"
          data-price="${product.price}">
          Add to Cart
        </button>

        <a href="product.html?id=${product.id}" class="view-btn">
          View Details
        </a>
      `;

      productList.appendChild(card);
    });
  } catch (err) {
    console.error("‚ùå Failed to load dolls", err);
    productList.innerHTML =
      "<p>‚ö†Ô∏è Error loading dolls products.</p>";
  }
});
</script>